import PT from 'prop-types';
import React, { Component } from 'react';
import { guid, autobind, requestAnimationFrame } from 'nav-frontend-js-utils';
import 'nav-frontend-skjema-style'; // eslint-disable-line import/extensions
import classNames from 'classnames';

const inputCls = (className, harFeil) => classNames(
    className,
    'skjemaelement__input textarea--medMeta',
    { 'skjemaelement__input--harFeil': harFeil }
);

/**
 * Selvekspanderende tekstområde med teller
 */
class Textarea extends Component {

    constructor(props) {
        super(props);
        autobind(this);
    }

    componentDidMount() {
        requestAnimationFrame(this.updateHeight, 0);
    }

    componentDidUpdate(prevProps) {
        if (prevProps.value !== this.props.value) {
            this.updateHeight();
        }
    }

    updateHeight() {
        if (this.mirror && this.tekstomrade) {
            this.mirror.textContent = `${this.tekstomrade.value} `;
            // eslint-disable-next-line no-param-reassign
            this.tekstomrade.style.height = `${this.mirror.offsetHeight + 25}px`;
        }
    }

    render() {
        const { label, maxLength, textareaClass, id, name, feil, tellerTekst, textareaRef, ...other } = this.props;
        const textareaId = id || name || guid();
        const antallTegn = other.value.length;

        return (
            <div className="skjemaelement textarea--container">
                <label className="skjemaelement__label" htmlFor={id}>
                    {label}
                </label>
                <textarea
                    ref={(textarea) => {
                        this.tekstomrade = textarea;
                        if (textareaRef !== undefined) textareaRef(textarea);
                    }}
                    onChange={this.handleChange}
                    className={inputCls(textareaClass, feil)}
                    type="text"
                    id={textareaId}
                    style={{ height: '30px' }}
                    {...other}
                />
                <p className="textarea--medMeta__teller">
                    { tellerTekst(antallTegn || 0, maxLength) }
                </p>
                <div role="alert" aria-live="assertive" className="skjemaelement__feilmelding">
                    {feil ? feil.feilmelding : null}
                </div>
                <div
                    className="textareamirror"
                    ref={(mirror) => { this.mirror = mirror; }}
                    aria-hidden="true"
                />
            </div>
        );
    }
}

function defaultTellerTekst(antallTegn, maxLength) {
    if (antallTegn > maxLength) {
        return <span>Du har {antallTegn - maxLength} tegn for mye</span>;
    }
    return <span>Du har {maxLength - antallTegn} tegn igjen</span>;
}

Textarea.propTypes = {
    /**
     * Ledetekst for tekstområdet
     */
    label: PT.node.isRequired,
    /**
     * Maks antal tegn som kan skrives inn i tekstområdet
     */
    maxLength: PT.number,
    /**
     * Teksten som er skrevet inn i tekstområdet.
     */
    value: PT.string.isRequired,
    /**
     * Klassenavn for tekstomnrådet
     */
    textareaClass: PT.string,
    /**
     * Id for tekstområdet, settes til name eller random guid hvis prop ikke er satt
     */
    id: PT.string,
    /**
     * Navn for tekstområdet, settes til id eller random guid hvis prop ikke er satt
     */
    name: PT.string,
    /**
     * Optional onChange handler
     */
    onChange: PT.func.isRequired,
    /**
     * Hvis skjemaet har feil sender man inn et objekt med en feilmelding
     */
    feil: PT.shape({
        feilmelding: PT.node.isRequired
    }),
    /**
     * Funksjon for å generere tellerteksten som vises nede i høyre hjørne
     */
    tellerTekst: PT.func,
    /**
     * Referanse til selve textareafeltet. Brukes for eksempel til å sette fokus
     */
    textareaRef: PT.func
};

Textarea.defaultProps = {
    maxLength: 2000,
    textareaClass: '',
    id: undefined,
    name: undefined,
    feil: undefined,
    tellerTekst: defaultTellerTekst,
    textareaRef: undefined
};

export default Textarea;
