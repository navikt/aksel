import * as React from 'react';
import * as PT from 'prop-types';
import { omit } from 'nav-frontend-js-utils';

import ToggleGruppePure from './toggle-gruppe-pure';
import { ToggleKnappPureProps, ToggleKnappPurePropsShape } from './toggle-knapp-pure';

export interface ToggleGruppeProps {
    /**
     * Array av toggle knapper, se `toggle-knapp-pure.tsx`
     */
    defaultToggles: ToggleKnappPureProps[];
    /**
     * Egendefinert klassenavn.
     */
    className?: string;
    /**
     * Hvis `true` vil det være mulig å velge flere knapper om gangen.
     */
    multiSelect?: boolean;
    /**
     * Hvis 'true' reduseres høyre/venstre-padding på knappene betraktelig.
     */
    kompakt?: boolean;
    /**
     * Custom onChange handler
     */
    onChange?: (event: React.SyntheticEvent<EventTarget>, toggles: ToggleKnappPureProps[]) => void;
    /**
     * Hvis 'true' så må minst 1 toggleknapp alltid være presset
     */
    minstEn?: boolean;
}

export interface ToggleGruppeState {
    toggles: ToggleKnappPureProps[];
}

class ToggleGruppe extends React.Component<ToggleGruppeProps, ToggleGruppeState> {
    constructor(props) {
        super(props);
        this.state = {
            toggles: this.setDefaultToggles()
        };
    }

    setDefaultToggles = () => {
        if (this.props.minstEn && !this.props.defaultToggles.some((toggle) => !!toggle.pressed)) {
            this.props.defaultToggles[0].pressed = true;
        }
        return this.props.defaultToggles;
    }

    handleClick = (e, index, customOnClick) => {
        if (typeof customOnClick === 'function') customOnClick(e);

        const toggles = this.state.toggles.map((toggle, i) => {
            if (i === index) toggle.pressed = !toggle.pressed;
            if (i !== index && !this.props.multiSelect) toggle.pressed = false;
            return toggle;
        });

        if (this.props.minstEn && !toggles.some((toggle) => !!toggle.pressed)) {
            toggles[index].pressed = true;
        }

        this.setState({
            toggles
        });

        if (typeof this.props.onChange === 'function') this.props.onChange(e, toggles);
    }

    render() {
        const { className, ...other } = this.props;
        const renderProps = omit(other, 'children', 'multiSelect', 'toggles', 'minstEn');
        const toggles = this.state.toggles.map((toggle, i) => ({
            ...toggle,
            kompakt: this.props.kompakt,
            onClick: (e) => this.handleClick(e, i, toggle.onClick)
        }));

        return (
            <ToggleGruppePure
                {...renderProps}
                toggles={toggles}
            />
        );
    }
}

(ToggleGruppe as React.ComponentClass).propTypes = {
    /**
     * Array av toggle knapper, se `toggle-knapp-pure.tsx`
     */
    defaultToggles: PT.arrayOf(ToggleKnappPurePropsShape).isRequired,
    /**
     * Egendefinert klassenavn.
     */
    className: PT.string,
    /**
     * Hvis `true` vil det være mulig å velge flere knapper om gangen.
     */
    multiSelect: PT.bool,
    /**
     * Hvis 'true' reduseres høyre/venstre-padding på knappene betraktelig.
     */
    kompakt: PT.bool,
    /**
     * Custom onChange handler
     */
    onChange: PT.func,
    /**
     * Hvis 'true' så må minst 1 toggleknapp alltid være presset
     */
    minstEn: PT.bool
};

export default ToggleGruppe;
