import * as PT from 'prop-types';
import * as React from 'react';
import * as sanitize from 'sanitize-html';
import { Normaltekst } from 'nav-frontend-typografi';

const leggTilLenkerTags = (innhold) => {
    const uriRegex = /(([\w-]+:\/\/?|www(?:-\w+)?\.)[^\s()<>]+\w)/g;
    const httpRegex = /^(https?):\/\/.*$/;

    return innhold.replace(uriRegex, (match) => {
        const matched = match.match(httpRegex) ? match : `http://${match}`;
        return `<a target="_blank" rel="noreferrer" href="${matched}">${matched}</a>`;
    });
};

const safeHtml = (content) => sanitize(content, { allowedTags: ['a'] });

const tilAvsnitt = (avsnitt, index, list) => ( // eslint-disable-next-line react/no-danger
    <Normaltekst
        className={index < list.length - 1 ? 'blokk-xs' : ''}
        dangerouslySetInnerHTML={{ __html: safeHtml(avsnitt) }}
        key={index}
    />
);

export interface TekstomradeProps {
    children: string;
    ingenFormattering?: boolean;
}

// eslint-disable-next-line react/prefer-stateless-function
class Tekstomrade extends React.Component<TekstomradeProps> {
    render() {
        const { children, ingenFormattering, ...props } = this.props;

        const tekst = children;
        const avsnitt = ingenFormattering ? tekst : tekst.split(/[\r\n]+/)
            .map(leggTilLenkerTags)
            .map(tilAvsnitt);

        return <div {...props}>{avsnitt}</div>;
    }
}

(Tekstomrade as React.ComponentClass).propTypes = {
    children: PT.string,
    ingenFormattering: PT.bool
};

(Tekstomrade as React.ComponentClass).defaultProps = {
    children: '',
    ingenFormattering: false
};

export default Tekstomrade;
